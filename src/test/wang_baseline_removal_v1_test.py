import os
import pathlib
import shutil
import tempfile
from glob import glob

import numpy as np

from wasp.wang_baseline_removal_v1 import wang_process

from .testutils import DATA_DIR, END_TO_END_DIR


def test_wang_process():
    tempdir = pathlib.Path(tempfile.mkdtemp())
    try:
        os.mkdir(tempdir / "plots")
        filepath = END_TO_END_DIR / "data" / "pedr.LXN.SAC"
        processed = wang_process(filepath, plot=True, directory=tempdir)
        np.testing.assert_array_almost_equal(
            processed,
            [
                1.31293535e-02,
                1.72712207e-02,
                2.52674222e-02,
                3.17635834e-02,
                3.62347960e-02,
                3.92434895e-02,
                4.09021676e-02,
                4.16609049e-02,
                4.23570871e-02,
                4.34907675e-02,
                4.56744730e-02,
                4.91081625e-02,
                5.27918637e-02,
                5.56380600e-02,
                5.70467412e-02,
                5.68804443e-02,
                5.57266474e-02,
                5.38728237e-02,
                5.05315065e-02,
                4.44402099e-02,
                3.51864100e-02,
                2.40826011e-02,
                1.23288035e-02,
                2.27398046e-02,
                7.75429282e-02,
                1.52810866e-01,
                2.25103788e-01,
                2.93709208e-01,
                3.56589632e-01,
                4.11782547e-01,
                4.58850484e-01,
                4.98330929e-01,
                5.30511325e-01,
                5.54479155e-01,
                5.68822206e-01,
                5.74140159e-01,
                5.72408075e-01,
                5.64213417e-01,
                5.48368861e-01,
                5.23299413e-01,
                4.88454803e-01,
                4.51459896e-01,
                4.27252570e-01,
                4.20545644e-01,
                4.31426141e-01,
                4.61719156e-01,
                5.01049666e-01,
                5.35718139e-01,
                5.56523525e-01,
                5.57865848e-01,
                5.42808789e-01,
                5.16201779e-01,
                4.78806806e-01,
                4.30512289e-01,
                3.75454313e-01,
                3.20372496e-01,
                2.67567100e-01,
                2.17935531e-01,
                1.75727364e-01,
                1.46582627e-01,
                1.33038094e-01,
                1.29230577e-01,
                1.29811868e-01,
                1.38117922e-01,
                1.50786082e-01,
                1.55592151e-01,
                1.46348690e-01,
                1.29603626e-01,
                1.21220379e-01,
                1.24460515e-01,
                1.26727903e-01,
                1.22208944e-01,
                1.12677473e-01,
                9.81449344e-02,
                7.76881706e-02,
                5.29703900e-02,
                2.93626863e-02,
                1.13664022e-02,
                -2.50237938e-03,
                -1.75766053e-02,
                -3.39325696e-02,
                -4.43109032e-02,
                -4.45421420e-02,
                -3.83341719e-02,
                -3.02951472e-02,
                -2.12795599e-02,
                -1.05015825e-02,
                1.35976900e-03,
                1.16342064e-02,
                1.68732434e-02,
                1.43608155e-02,
                5.45495506e-03,
                -3.74082240e-03,
                -7.77149976e-03,
                -6.10301941e-03,
                -2.82473681e-03,
                -1.51483800e-03,
                -1.09757835e-03,
                2.80985014e-04,
                2.07153568e-03,
                3.19832902e-03,
                4.19542266e-03,
                6.39796063e-03,
                8.17325250e-03,
                6.80523383e-03,
                2.74017768e-03,
                -1.52587897e-04,
                -9.18021215e-12,
                1.52587877e-04,
                -3.05175797e-04,
            ],
            decimal=9,
        )
        for f in [
            "pedr_LXN_plot2.png",
            "pedr_LXN_plot3.png",
            "pedr_LXN_plot4.png",
            "pedr_LXN_plot5.png",
        ]:
            assert (tempdir / "plots" / f).exists()
    finally:
        shutil.rmtree(tempdir)
